# ------------------------------------------------------------------------------
# autumo Sentinel â€“ Multi-Stage Supply-Chain Malware Scanner & Code Forensics
# Version 3.0 | Copyright (c) 2025 autumo GmbH
# SPDX-License-Identifier: GPL-3.0-or-later OR LicenseRef-commercial
# Dual license: GPL-3.0 (https://www.gnu.org/licenses/gpl-3.0.en.html)
# ------------------------------------------------------------------------------

name: Build autumo Sentinel Releases

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build'
        required: true
        default: 'master'

env:
  VERSION: 3.0.0
  BIN_NAME: sentinel
  DIST_DIR: dist

jobs:
  build:
    strategy:
      matrix:
        os: [macos-15-intel, macos-latest, ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------- Setup Python ---------
      - name: Setup Python 3.12 (macOS/Linux)
        if: runner.os != 'Windows'
        uses: actions/setup-python@v4
        with:
          python-version: 3.12.0

      - name: Install PyInstaller
        run: python -m pip install --upgrade pip setuptools wheel pyinstaller

      # --------- Clean previous builds ---------
      - name: Clean previous builds (Windows)
        if: matrix.os == 'windows-latest'
        run: Remove-Item -Recurse -Force dist, build, sentinel.spec -ErrorAction SilentlyContinue
        shell: pwsh

      - name: Clean previous builds (macOS/Linux)
        if: matrix.os != 'windows-latest'
        run: rm -rf ${{ env.DIST_DIR }} build sentinel.spec
        shell: bash

      # --------- Build sentinel CLI ---------
      - name: Build CLI (Windows)
        if: matrix.os == 'windows-latest'
        run: pyinstaller --name ${{ env.BIN_NAME }} --onefile --distpath ${{ env.DIST_DIR }} app/sentinel.py
        shell: pwsh

      - name: Build CLI (macOS ARM)
        if: matrix.os == 'macos-latest'
        run: pyinstaller --name ${{ env.BIN_NAME }} --onefile --target-arch arm64 --distpath ${{ env.DIST_DIR }} app/sentinel.py
        shell: bash

      - name: Build CLI (macOS Intel / Linux)
        if: matrix.os != 'windows-latest' && matrix.os != 'macos-latest'
        run: pyinstaller --name ${{ env.BIN_NAME }} --onefile --target-arch x86_64 --distpath ${{ env.DIST_DIR }} app/sentinel.py
        shell: bash

      # --------- Package ZIP ---------
      - name: Package ZIP (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          New-Item -ItemType Directory -Force -Path "dist\rules" | Out-Null
          Copy-Item -Recurse -Force config dist
          Copy-Item -Recurse -Force patterns dist
          Copy-Item -Force rules\rules.low* "dist\rules"
          Copy-Item -Force rules\rule-set-policy.md "dist\rules"
          Copy-Item -Force README.md dist
          Copy-Item -Force LICENSE dist

          cd dist
          $zipBaseName = "autumo-Sentinel-$env:VERSION-windows-x64"
          $zipPath = "${zipBaseName}.zip"
          Compress-Archive * -DestinationPath $zipPath -Force
          "ZIP_BASENAME=$zipBaseName" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Output "ZIP file created: $zipPath"
        shell: pwsh

      - name: Package ZIP (macOS/Linux)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p "dist/rules"
          cp -r config "dist"
          cp -r patterns "dist"
          cp rules/rules.low* "dist/rules"
          cp rules/rule-set-policy.md "dist/rules"
          cp LICENSE "dist"
          cp README.md "dist"

          ZIP_BASENAME="autumo-Sentinel-${{ env.VERSION }}"
          case "${{ matrix.os }}" in
            macos-15-intel)  ZIP_BASENAME="$ZIP_BASENAME-macos-x64" ;;
            macos-latest)    ZIP_BASENAME="$ZIP_BASENAME-macos-arm64" ;;
            ubuntu-latest)   ZIP_BASENAME="$ZIP_BASENAME-linux-x64" ;;
          esac

          cd dist
          ZIP_PATH="${ZIP_NAME}.zip"
          zip -r "$ZIP_PATH" * -x "*/.DS_Store" -x "*/__MACOSX"
          echo "ZIP_BASENAME=$ZIP_BASENAME" >> $GITHUB_ENV
          echo "ZIP file created: $ZIP_PATH"
        shell: bash

      # --------- Upload artifact ---------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_BASENAME }}
          path: |
            if: matrix.os == 'macos-15-intel'
              dist/autumo-Sentinel-${{ env.VERSION }}-macos-x64.zip
            if: matrix.os == 'macos-latest'
              dist/autumo-Sentinel-${{ env.VERSION }}-macos-arm64.zip
            if: matrix.os == 'ubuntu-latest'
              dist/autumo-Sentinel-${{ env.VERSION }}-linux-x64.zip
            if: matrix.os == 'windows-latest'
              dist/autumo-Sentinel-${{ env.VERSION }}-windows-x64.zip
