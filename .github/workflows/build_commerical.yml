# ------------------------------------------------------------------------------
# autumo Sentinel â€“ Multi-Stage Supply-Chain Malware Scanner & Code Forensics
# Version 3.0 | Copyright (c) 2025 autumo GmbH
# SPDX-License-Identifier: GPL-3.0-or-later OR LicenseRef-commercial
# Dual license: GPL-3.0 (https://www.gnu.org/licenses/gpl-3.0.en.html)
# ------------------------------------------------------------------------------

name: Build autumo Sentinel Releases (Commercial)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build'
        required: true
        default: 'master'

env:
  VERSION: 3.0.0c
  PYTHON_VERSION: 3.12.0
  DIST_DIR: dist
  BIN_NAME: sentinel

jobs:
  build:
    strategy:
      matrix:
        os: [macos-15-intel, macos-latest, ubuntu-22.04, windows-latest]
    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.os }}

    steps:
      # --------- Checkout ---------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------- Checkout private rules ---------
      - name: Checkout private rules
        uses: actions/checkout@v4
        with:
          repository: autumoswitzerland/autumo-sentinel-private
          token: ${{ secrets.RULES_REPO_TOKEN }}
          path: rules_commercial

      # --------- Setup Python ---------
      - name: Setup Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PyInstaller
        run: python -m pip install --upgrade pip setuptools wheel pyinstaller

      # --------- Clean previous builds ---------
      - name: Clean previous builds (Windows)
        shell: pwsh
        if: matrix.os == 'windows-latest'
        run: Remove-Item -Recurse -Force ${{ env.DIST_DIR }}, build, ${{ env.BIN_NAME }}.spec -ErrorAction SilentlyContinue

      - name: Clean previous builds (macOS/Linux)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: rm -rf ${{ env.DIST_DIR }} build ${{ env.BIN_NAME }}.spec

      # -------- Patch (macOS/Linux)
      - name: Patch source
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          sed -i.bak \
            -e 's/^COMMERCIAL_BUILD = False$/COMMERCIAL_BUILD = True/' \
            -e 's/^VERSION = "3.0.0"$/VERSION = "3.0.0c"/' \
            app/build_info.py

      # -------- Patch (Windows)
      - name: Patch source (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Copy-Item app/build_info.py app/build_info.py.bak
          (Get-Content app/build_info.py) `
            -replace '^COMMERCIAL_BUILD = False$', 'COMMERCIAL_BUILD = True' `
            -replace '^VERSION = "3.0.0"$', 'VERSION = "3.0.0c"' |
          Set-Content app/build_info.py

      # --------- Build sentinel CLI ---------
      - name: Build CLI (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          pyinstaller --name ${{ env.BIN_NAME }} `
            --onefile --icon "app/resources/icon.ico" `
            --distpath ${{ env.DIST_DIR }} app/${{ env.BIN_NAME }}.py

      - name: Build CLI (macOS ARM)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          pyinstaller --name ${{ env.BIN_NAME }} \
            --onefile --icon "app/resources/icon.icns" \
            --target-architecture arm64 \
            --distpath ${{ env.DIST_DIR }} app/${{ env.BIN_NAME }}.py

      - name: Build CLI (macOS Intel)
        if: matrix.os == 'macos-15-intel'
        shell: bash
        run: |
          pyinstaller --name ${{ env.BIN_NAME }} \
            --onefile --icon "app/resources/icon.icns" \
            --target-arch x86_64 \
            --distpath ${{ env.DIST_DIR }} app/${{ env.BIN_NAME }}.py

      - name: Build CLI (Linux)
        if: matrix.os == 'ubuntu-22.04'
        shell: bash
        run: |
          pyinstaller --name ${{ env.BIN_NAME }} \
            --onefile --icon "app/resources/icon.png" \
            --distpath ${{ env.DIST_DIR }} app/${{ env.BIN_NAME }}.py

      # -------- Restore Source
      - name: Restore source
        shell: bash
        run: |
          if [ -f app/build_info.py.bak ]; then
            mv app/build_info.py.bak app/build_info.py
          fi

      # --------- Prepare Artifact Contents ---------
      - name: Prepare Artifact Contents
        shell: bash
        run: |
          mkdir -p "${{ env.DIST_DIR }}/rules"
          cp -r config "${{ env.DIST_DIR }}"
          cp -r patterns "${{ env.DIST_DIR }}"
          cp rules/rule* "${{ env.DIST_DIR }}/rules"
          cp rules_commercial/rules/rule* rules/
          cp README.md "${{ env.DIST_DIR }}"
          cp LICENSE "${{ env.DIST_DIR }}"
          cp .github/resources/LICENSE_COMMERCIAL.html "${{ env.DIST_DIR }}"

          ZIP_BASENAME="autumo-Sentinel-${{ env.VERSION }}"
          case "${{ matrix.os }}" in
            ubuntu-22.04)    ZIP_BASENAME="$ZIP_BASENAME-linux-x64" ;;
            macos-latest)    ZIP_BASENAME="$ZIP_BASENAME-macos-arm64" ;;
            macos-15-intel)  ZIP_BASENAME="$ZIP_BASENAME-macos-x64" ;;
            windows-latest)  ZIP_BASENAME="$ZIP_BASENAME-windows-x64" ;;
          esac

          rm -rf release
          mkdir release
          mkdir "release/$ZIP_BASENAME"
          cp -r ${{ env.DIST_DIR }}/* "release/$ZIP_BASENAME/"

          echo "ZIP_BASENAME=$ZIP_BASENAME" >> $GITHUB_ENV

      # --------- ZIP artifact ---------
      - name: Zip release (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          cd release
          zip -r "${ZIP_BASENAME}.zip" "$ZIP_BASENAME"
          cd ..

      - name: Zip release (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Compress-Archive -Path "release/${env:ZIP_BASENAME}" -DestinationPath "release/${env:ZIP_BASENAME}.zip"

      # --------- Upload artifact ---------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_BASENAME }}
          path: release/${{ env.ZIP_BASENAME }}.zip
          # Without ZIP -> path: release/*
